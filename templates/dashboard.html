{% extends 'base.html' %}

{% block content %}
<div class="row">
    <!-- NEW: Daily Log Quick Action -->
    <div class="col-md-12 mb-4">
        <div class="card p-3 border-0 shadow-sm"
            style="background: #ffffff; border-left: 5px solid #2d7f3e !important;">
            <form action="{{ url_for('quick_note') }}" method="POST" class="d-flex align-items-center gap-2">
                <span class="fs-4">ğŸ“</span>
                <input type="text" name="content" class="form-control"
                    placeholder="What did you do today in the farm? (e.g., 'Watered the Tomato crop')" required>
                <button type="submit" class="btn btn-success">Save Log</button>
            </form>
        </div>
    </div>
</div>

<div class="row mb-5">
    <div class="col-md-4 mb-3">
        <div class="stat-card stat-income">
            <h5>ğŸ’° Total Income</h5>
            <div class="display-value">â‚¹{{ "%.0f"|format(income) }}</div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="stat-card stat-expense">
            <h5>ğŸ’¸ Total Expenses</h5>
            <div class="display-value">â‚¹{{ "%.0f"|format(expense) }}</div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="stat-card stat-profit">
            <h5>ğŸ“ˆ Net Profit</h5>
            <div class="display-value">â‚¹{{ "%.0f"|format(profit) }}</div>
        </div>
    </div>
</div>

<!-- Expense Breakdown by Category -->
<div class="row mb-5">
    <div class="col-md-12">
        <div class="card p-4">
            <h4>ğŸ’¸ Expense Breakdown by Category</h4>
            <div class="row mt-4">
                {% for expense_cat, expense_amt in expense_breakdown.items() %}
                <div class="col-md-2 col-sm-4 col-6 mb-3">
                    <div class="expense-category">
                        <h6>
                            {% if expense_cat == 'Fuel' %}ğŸ›¢ï¸{% elif expense_cat == 'Labour' %}ğŸ‘·{% elif expense_cat ==
                            'Food' %}ğŸ¥•{% elif expense_cat == 'Transportation' %}ğŸšš{% else %}ğŸ“¦{% endif %}
                            {{ expense_cat }}
                        </h6>
                        <div class="amount">â‚¹{{ "%.0f"|format(expense_amt) }}</div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-5">
        <div class="card p-4">
            <h4>â• Add Daily Record</h4>
            <form action="/add_record" method="POST">
                <div class="mb-3">
                    <label class="form-label fw-600">ğŸ“… Date</label>
                    <input type="date" id="dateInput" name="date" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-600">ğŸ“ Activity Name</label>
                    <input type="text" name="activity" class="form-control"
                        placeholder="e.g., Bought Seeds, Watered Field" required>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-600">ğŸ“‚ Category</label>
                    <select name="category" class="form-select" id="categorySelect" onchange="toggleExpenseType()">
                        <option value="Expense">ğŸ’¸ Expense (Cost)</option>
                        <option value="Income">ğŸ’° Income (Sales)</option>
                    </select>
                </div>
                <div class="mb-3" id="expenseTypeDiv">
                    <label class="form-label fw-600">ğŸ·ï¸ Expense Type</label>
                    <select name="expense_type" class="form-select">
                        <option value="">Select Type</option>
                        <option value="Fuel">ğŸ›¢ï¸ Fuel</option>
                        <option value="Labour">ğŸ‘· Labour</option>
                        <option value="Seed">ğŸŒ± Seed</option>
                        <option value="Water">ğŸ’§ Water</option>
                        <option value="Transportation">ğŸšš Transportation</option>
                        <option value="Misc">ğŸ“¦ Misc</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-600">ğŸ’µ Amount</label>
                    <input type="number" step="0.01" name="amount" class="form-control" placeholder="0.00" required>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-600">ğŸ“„ Description (Optional)</label>
                    <input type="text" name="desc" class="form-control" placeholder="Add details...">
                </div>
                <button type="submit" class="btn btn-success w-100">âœ… Save Record</button>
            </form>
        </div>
    </div>

    <div class="col-md-7">
        <div class="card p-4">
            <h4>ğŸ“Š Financial Chart</h4>
            <canvas id="profitChart"></canvas>
        </div>
    </div>
</div>

<!-- Records List -->
<div class="row mt-5">
    <div class="col-md-12">
        <div class="card p-4">
            <h4>ğŸ“‹ All Records (Edit & Delete)</h4>
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>ğŸ“… Date</th>
                            <th>ğŸ“ Activity</th>
                            <th>ğŸ·ï¸ Type</th>
                            <th>ğŸ“‚ Category</th>
                            <th>ğŸ’µ Amount</th>
                            <th>ğŸ“„ Description</th>
                            <th>âš™ï¸ Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for record in records|sort(attribute='date', reverse=True) %}
                        <tr>
                            <td><strong>{{ record.date.strftime('%d-%m-%Y') }}</strong></td>
                            <td>{{ record.activity_type }}</td>
                            <td>
                                {% if record.expense_type %}
                                <span class="badge bg-warning text-dark">{{ record.expense_type }}</span>
                                {% else %}
                                <span class="badge bg-secondary">-</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if record.category == 'Income' %}
                                <span class="badge bg-success">ğŸ’° Income</span>
                                {% else %}
                                <span class="badge bg-danger">ğŸ’¸ Expense</span>
                                {% endif %}
                            </td>
                            <td
                                class="fw-bold {% if record.category == 'Income' %}text-success{% else %}text-danger{% endif %}">
                                â‚¹{{ "%.2f"|format(record.amount) }}
                            </td>
                            <td>{{ record.description or '-' }}</td>
                            <td>
                                <a href="{{ url_for('edit_record', record_id=record.id) }}"
                                    class="btn btn-sm btn-warning">âœï¸ Edit</a>
                                <form method="POST" action="{{ url_for('delete_record', record_id=record.id) }}"
                                    style="display:inline;">
                                    <button type="submit" class="btn btn-sm btn-danger"
                                        onclick="return confirm('Delete this record?')">ğŸ—‘ï¸</button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    // Set date input to today's date by default
    document.getElementById('dateInput').valueAsDate = new Date();

    // Toggle expense type field
    function toggleExpenseType() {
        const category = document.getElementById('categorySelect').value;
        const expenseTypeDiv = document.getElementById('expenseTypeDiv');
        expenseTypeDiv.style.display = category === 'Expense' ? 'block' : 'none';
    }
    toggleExpenseType(); // Run on page load

    // Simple Chart Logic
    const ctx = document.getElementById('profitChart').getContext('2d');
    const myChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Income', 'Expenses'],
            datasets: [{
                label: 'Financials',
                data: [{{ income }}, {{ expense }}],
        backgroundColor: ['#198754', '#dc3545'],
    }]
        },
    options: {
        responsive: true,
            plugins: {
            legend: { display: true, position: 'bottom' }
        }
    }
    });
</script>
{% endblock %}