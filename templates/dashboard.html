{% extends 'base.html' %}

{% block content %}
<div class="row">
    <!-- NEW: Daily Log Quick Action -->
    <div class="col-md-12 mb-4">
        <div class="card p-3 border-0 shadow-sm"
            style="background: #ffffff; border-left: 5px solid #2d7f3e !important;">
            <form action="{{ url_for('quick_note') }}" method="POST" class="d-flex align-items-center gap-2">
                <span class="fs-4">ğŸ“</span>
                <input type="text" name="content" class="form-control"
                    placeholder="What did you do today in the farm? (e.g., 'Watered the Tomato crop')" required>
                <button type="submit" class="btn btn-success">Save Log</button>
            </form>
        </div>
    </div>
</div>

<div class="row mb-5">
    <div class="col-md-4 mb-3">
        <div class="stat-card stat-income">
            <h5>ğŸ’° Total Income</h5>
            <div class="display-value">â‚¹{{ "%.0f"|format(income) }}</div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="stat-card stat-expense">
            <h5>ğŸ’¸ Total Expenses</h5>
            <div class="display-value">â‚¹{{ "%.0f"|format(expense) }}</div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="stat-card stat-profit">
            <h5>ğŸ“ˆ Net Profit</h5>
            <div class="display-value">â‚¹{{ "%.0f"|format(profit) }}</div>
        </div>
    </div>
</div>

<!-- Expense Breakdown by Category -->
<div class="row mb-5">
    <div class="col-md-12">
        <div class="card p-4">
            <h4>ğŸ’¸ Expense Breakdown by Category</h4>
            <div class="row mt-4">
                {% for expense_cat, expense_amt in expense_breakdown.items() %}
                <div class="col-md-2 col-sm-4 col-6 mb-3">
                    <div class="expense-category">
                        <h6>
                            {% if expense_cat == 'Fuel' %}ğŸ›¢ï¸{% elif expense_cat == 'Labour' %}ğŸ‘·{% elif expense_cat ==
                            'Food' %}ğŸ¥•{% elif expense_cat == 'Transportation' %}ğŸšš{% else %}ğŸ“¦{% endif %}
                            {{ expense_cat }}
                        </h6>
                        <div class="amount">â‚¹{{ "%.0f"|format(expense_amt) }}</div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-5">
        <div class="card p-4">
            <h4>â• Add Daily Record</h4>
            <form action="/add_record" method="POST">
                <div class="mb-3">
                    <label class="form-label fw-600">ğŸ“… Date</label>
                    <input type="date" id="dateInput" name="date" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-600">ğŸ“ Activity Name</label>
                    <input type="text" name="activity" class="form-control"
                        placeholder="e.g., Bought Seeds, Watered Field" required>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-600">ğŸ“‚ Category</label>
                    <select name="category" class="form-select" id="categorySelect" onchange="toggleExpenseType()">
                        <option value="Expense">ğŸ’¸ Expense (Cost)</option>
                        <option value="Income">ğŸ’° Income (Sales)</option>
                    </select>
                </div>
                <div class="mb-3" id="expenseTypeDiv">
                    <label class="form-label fw-600">ğŸ·ï¸ Expense Type</label>
                    <select name="expense_type" class="form-select">
                        <option value="">Select Type</option>
                        <option value="Fuel">ğŸ›¢ï¸ Fuel</option>
                        <option value="Labour">ğŸ‘· Labour</option>
                        <option value="Seed">ğŸŒ± Seed</option>
                        <option value="Water">ğŸ’§ Water</option>
                        <option value="Transportation">ğŸšš Transportation</option>
                        <option value="Misc">ğŸ“¦ Misc</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-600">ğŸ’µ Amount</label>
                    <input type="number" step="0.01" name="amount" class="form-control" placeholder="0.00" required>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-600">ğŸ“„ Description (Optional)</label>
                    <input type="text" name="desc" class="form-control" placeholder="Add details...">
                </div>
                <button type="submit" class="btn btn-success w-100">âœ… Save Record</button>
            </form>
        </div>
    </div>

    <div class="col-md-7">
        <div class="card p-4">
            <h4>ğŸ“Š Financial Chart</h4>
            <canvas id="profitChart"></canvas>
        </div>
    </div>
</div>

<!-- Records List -->
<div class="row mt-5">
    <div class="col-md-12">
        <div class="card p-4">
            <h4>ğŸ“‹ All Records (Grouped by Date)</h4>

            {% set records_by_date = {} %}
            {% for record in records|sort(attribute='date', reverse=True) %}
            {% set date_key = record.date.strftime('%Y-%m-%d') %}
            {% if date_key not in records_by_date %}
            {% set _ = records_by_date.update({date_key: []}) %}
            {% endif %}
            {% set _ = records_by_date[date_key].append(record) %}
            {% endfor %}

            {% for date_str, date_records in records_by_date.items() %}
            <div class="date-record-box mb-4 p-3"
                style="border: 2px solid #e0e0e0; border-radius: 12px; background: #f8f9fa;">
                <div class="d-flex justify-content-between align-items-center mb-3 pb-2"
                    style="border-bottom: 2px solid #2d7f3e;">
                    <h5 class="mb-0" style="color: #2d7f3e;">
                        ğŸ“… {{ date_records[0].date.strftime('%A, %d %B %Y') }}
                    </h5>
                    <span class="badge bg-secondary">{{ date_records|length }} record(s)</span>
                </div>

                <div class="table-responsive">
                    <table class="table table-sm mb-0">
                        <thead>
                            <tr style="background: #ffffff;">
                                <th>ğŸ“ Activity</th>
                                <th>ğŸ·ï¸ Type</th>
                                <th>ğŸ“‚ Category</th>
                                <th>ğŸ’µ Amount</th>
                                <th>ğŸ“„ Description</th>
                                <th>âš™ï¸ Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for record in date_records %}
                            <tr style="background: #ffffff;">
                                <td><strong>{{ record.activity_type }}</strong></td>
                                <td>
                                    {% if record.expense_type %}
                                    <span class="badge bg-warning text-dark">{{ record.expense_type }}</span>
                                    {% else %}
                                    <span class="badge bg-secondary">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if record.category == 'Income' %}
                                    <span class="badge bg-success">ğŸ’° Income</span>
                                    {% else %}
                                    <span class="badge bg-danger">ğŸ’¸ Expense</span>
                                    {% endif %}
                                </td>
                                <td
                                    class="fw-bold {% if record.category == 'Income' %}text-success{% else %}text-danger{% endif %}">
                                    â‚¹{{ "%.2f"|format(record.amount) }}
                                </td>
                                <td>{{ record.description or '-' }}</td>
                                <td>
                                    <a href="{{ url_for('edit_record', record_id=record.id) }}"
                                        class="btn btn-sm btn-warning">âœï¸</a>
                                    <form method="POST" action="{{ url_for('delete_record', record_id=record.id) }}"
                                        style="display:inline;">
                                        <button type="submit" class="btn btn-sm btn-danger"
                                            onclick="return confirm('Delete this record?')">ğŸ—‘ï¸</button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Daily Summary for this date -->
                <div class="mt-3 p-2" style="background: #e8f5e9; border-radius: 8px;">
                    {% set day_income = date_records|selectattr('category', 'equalto',
                    'Income')|map(attribute='amount')|sum %}
                    {% set day_expense = date_records|selectattr('category', 'equalto',
                    'Expense')|map(attribute='amount')|sum %}
                    {% set day_net = day_income - day_expense %}
                    <div class="row text-center">
                        <div class="col-4">
                            <small class="text-muted">Income</small><br>
                            <strong class="text-success">â‚¹{{ "%.0f"|format(day_income) }}</strong>
                        </div>
                        <div class="col-4">
                            <small class="text-muted">Expense</small><br>
                            <strong class="text-danger">â‚¹{{ "%.0f"|format(day_expense) }}</strong>
                        </div>
                        <div class="col-4">
                            <small class="text-muted">Net</small><br>
                            <strong class="{% if day_net >= 0 %}text-success{% else %}text-danger{% endif %}">â‚¹{{
                                "%.0f"|format(day_net) }}</strong>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}

            {% if records|length == 0 %}
            <div class="alert alert-info">
                No records found. Add your first entry above! ğŸ“
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
    // Set date input to today's date by default
    document.getElementById('dateInput').valueAsDate = new Date();

    // Toggle expense type field
    function toggleExpenseType() {
        const category = document.getElementById('categorySelect').value;
        const expenseTypeDiv = document.getElementById('expenseTypeDiv');
        expenseTypeDiv.style.display = category === 'Expense' ? 'block' : 'none';
    }
    toggleExpenseType(); // Run on page load

    // Simple Chart Logic
    const ctx = document.getElementById('profitChart').getContext('2d');
    const myChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Income', 'Expenses'],
            datasets: [{
                label: 'Financials',
                data: [{{ income }}, {{ expense }}],
        backgroundColor: ['#198754', '#dc3545'],
    }]
        },
    options: {
        responsive: true,
            plugins: {
            legend: { display: true, position: 'bottom' }
        }
    }
    });
</script>
{% endblock %}